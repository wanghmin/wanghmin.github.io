<style>
  .pub-thumb-inline {
    float: left;
    width: 96px;
    height: 96px;
    object-fit: cover;
    border-radius: 6px;
    margin: 4px 12px 6px 0;
    background: #f2f2f2;
  }
  .pub-list-item.view-citation { overflow: auto; }
</style>

<script>
(function addPubThumbs(){
  const items = Array.from(document.querySelectorAll('.pub-list-item.view-citation'));
  if (!items.length) return;

  items.forEach(async (el) => {
    if (el.dataset.thumbAdded === '1') return;
    el.dataset.thumbAdded = '1';

    const a = el.querySelector('a[href*="/publication/"]') || el.querySelector('a.underline');
    if (!a) return;

    // Base = the paper page folder (e.g., /publication/yuan-2024-vhk/)
    const base = new URL(a.getAttribute('href'), location.origin);
    if (!base.pathname.endsWith('/')) base.pathname += '/';

    // 1) Try common filenames right in that folder
    const tryNames = ['featured.png','featured.webp','featured.jpg','featured.jpeg','featured.gif'];
    const directCandidates = tryNames.map(n => new URL(n, base).href);

    let src = await firstLoadable(directCandidates);

    // 2) Fallback: fetch the paper page and look for any image that includes "featured"
    if (!src) {
      try {
        const html = await fetch(base.href, { credentials: 'same-origin' }).then(r => r.text());
        const doc  = new DOMParser().parseFromString(html, 'text/html');
        // Prefer images with "featured" in the filename; else first image in article
        let cand = doc.querySelector('img[src*="featured"]')?.getAttribute('src')
                 || doc.querySelector('figure img, article img')?.getAttribute('src');
        if (cand) src = new URL(cand, base).href;
      } catch (e) {
        // silent â€“ leave without thumb
      }
    }

    if (!src) return; // no image found

    // Insert floated thumbnail (clickable)
    const img  = document.createElement('img');
    img.className = 'pub-thumb-inline';
    img.loading   = 'lazy';
    img.decoding  = 'async';
    img.alt       = 'thumbnail';
    img.src       = src;

    const link = document.createElement('a');
    link.href = a.href;
    link.appendChild(img);
    el.insertBefore(link, el.firstChild);

    // Debug so you can verify in DevTools
    console.log('[pub-thumbs] inserted', src, 'for', base.href);
  });

  function firstLoadable(urls){
    // Try sequentially so we don't spam requests
    return new Promise(async (resolve) => {
      for (const u of urls) {
        try { await loadImage(u); return resolve(u); }
        catch { /* try next */ }
      }
      resolve(null);
    });
  }

  function loadImage(url){
    return new Promise((resolve, reject) => {
      const i = new Image();
      i.onload = () => resolve(url);
      i.onerror = reject;
      i.src = url;
    });
  }
})();
</script>
