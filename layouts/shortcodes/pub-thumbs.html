<!-- /layouts/shortcodes/pub-thumbs.html -->

<style>
  /* Flexbox layout for publication items */
  .pub-list-item.view-citation {
    display: flex;
    margin-bottom: 1rem;
  }

  /* Small, floated thumbnail that doesn’t alter the item’s layout */
  .pub-thumb-inline {
    width: 96px;  /* Enforce width */
    height: 96px; /* Enforce height */
    object-fit: cover; /* Maintain aspect ratio while filling the area */
    border-radius: 6px;
    background: #f2f2f2;
    margin: 4px 12px 6px 0;
  }

  /* Left column for the image */
  .image-left .pub-thumb-inline {
    margin-right: 12px;
  }

  /* Right column for the text */
  .text-right .pub-thumb-inline {
    margin-left: 12px;
  }

  /* Media query for narrow screens (like mobile devices) */
  @media (max-width: 768px) {
    /* On mobile, hide the image and just show text */
    .pub-thumb-inline {
      display: none;
    }

    /* Adjust text to take full width */
    .pub-citation-text {
      flex: 1;
    }
  }
</style>

<script>
(function addPubThumbs(){
  // Wait until the list is present (helps if hydration/JS reflows late)
  function ready(fn){
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fn);
    } else {
      fn();
    }
    window.addEventListener('load', () => setTimeout(fn, 0));
  }

  ready(() => {
    const items = Array.from(document.querySelectorAll('.pub-list-item.view-citation'));
    if (!items.length) return;

    const names = ['featured','teaser','thumb','thumbnail','cover','image'];
    const exts  = ['png','webp','jpg','jpeg','gif'];

    items.forEach((el, index) => {
      if (el.dataset.thumbAdded === '1') return;
      el.dataset.thumbAdded = '1';

      // Alternate the layout based on index
      if (index % 2 === 0) {
        el.classList.add('image-left'); // Image on the left
      } else {
        el.classList.add('text-right'); // Text on the left
      }

      // Find the publication page link (e.g., /publication/yuan-2024-vhk/)
      const a = el.querySelector('a[href*="/publication/"]') || el.querySelector('a.underline');
      if (!a) return;

      // Base folder URL, robust to subpaths/domains.
      const base = new URL(a.getAttribute('href'), document.baseURI);
      if (!base.pathname.endsWith('/')) base.pathname += '/';

      // Build candidate URLs in that folder
      const candidates = [];
      for (const n of names) for (const e of exts) {
        candidates.push(new URL(n + '.' + e, base).href);
      }

      // Create the <img>, try each candidate sequentially using onerror
      const img = document.createElement('img');
      img.className = 'pub-thumb-inline';
      img.loading = 'lazy';
      img.decoding = 'async';
      img.alt = 'thumbnail';

      let i = 0;
      function tryNext(){
        if (i >= candidates.length) { img.remove(); return; }
        const url = candidates[i++];
        img.src = url; // this will trigger a network request you can see in DevTools
      }
      img.onerror = tryNext;
      img.onload  = () => { /* success: keep it */ };

      // Insert at start, wrapped in a link to the paper page
      const link = document.createElement('a');
      link.href = a.href;
      link.appendChild(img);
      el.insertBefore(link, el.firstChild);

      // Kick off the first attempt
      tryNext();
    });
  });
})();
</script>
