{{ define "main" }}
<main class="container mx-auto px-4">

  {{/* Collect publications (robust) */}}
  {{ $pubs := where .Site.RegularPages "Type" "publication" }}
  {{ if eq (len $pubs) 0 }}{{ $pubs = where .Site.RegularPages "Section" "publication" }}{{ end }}

  {{ if eq (len $pubs) 0 }}
    <p>No publications found.</p>
  {{ else }}
    {{ $sorted := $pubs.ByDate.Reverse }}
    {{ $currentYear := "" }}

    {{ range $p := $sorted }}
      {{/* Year: prefer publication_year, else .Date */}}
      {{ $y := cond $p.Params.publication_year (printf "%v" $p.Params.publication_year) ($p.Date.Format "2006") }}

      {{ if ne $y $currentYear }}
        {{ if ne $currentYear "" }}</ul></section>{{ end }}
        <section id="y-{{ $y }}" class="mb-8">
          <h2 class="year-heading text-2xl font-semibold mt-10 mb-4">{{ $y }}</h2>
          <ul class="list-none space-y-3">
        {{ $currentYear = $y }}
      {{ end }}

      {{/* ---------- Authors: resolve slugs to profile titles; bold admin ---------- */}}
      {{ $authorNames := slice }}
      {{ range $slug := ($p.Params.authors | default (slice)) }}
        {{ $apage := site.GetPage (printf "authors/%s" $slug) }}
        {{ $name := cond $apage $apage.Title $slug }}
        {{ if eq (lower $slug) "admin" }}
          {{ $authorNames = $authorNames | append (printf "<strong>%s</strong>" $name) }}
        {{ else }}
          {{ $authorNames = $authorNames | append $name }}
        {{ end }}
      {{ end }}
      {{ $authorsHTML := (delimit $authorNames ", ") | safeHTML }}

      {{/* Venue + vol/num */}}
      {{ $venue := cond $p.Params.publication $p.Params.publication $p.Params.journal }}
      {{ $vol := $p.Params.volume }}
      {{ $num := $p.Params.number }}

      {{/* ---------- Build links (auto-discover from page bundle) ---------- */}}
      {{/* PDF: first *.pdf in the page bundle (if any) */}}
      {{ $pdf := $p.Params.url_pdf }}
      {{ if not $pdf }}
        {{ with index ($p.Resources.Match "**.pdf") 0 }}{{ $pdf = .RelPermalink }}{{ end }}
      {{ end }}

      {{/* CITE: url_cite, or first *.bib / *.ris */}}
      {{ $cite := $p.Params.url_cite }}
      {{ if not $cite }}
        {{ with index ($p.Resources.Match "**.bib") 0 }}{{ $cite = .RelPermalink }}{{ end }}
        {{ if not $cite }}
          {{ with index ($p.Resources.Match "**.ris") 0 }}{{ $cite = .RelPermalink }}{{ end }}
        {{ end }}
      {{ end }}

      {{ $code := $p.Params.url_code }}
      {{ $data := or $p.Params.url_dataset $p.Params.url_data }}
      {{ $video := $p.Params.url_video }}
      {{ $page := $p.RelPermalink }}
      {{ $titleHref := $page }}
      {{ if $p.Params.url_custom }}{{ $titleHref = $p.Params.url_custom }}{{ end }}
      {{ if $pdf }}{{ $titleHref = $pdf }}{{ end }}

      <li class="pub-item leading-snug">
        {{ $authorsHTML }}
        {{ if $y }} ({{ $y }}).{{ end }}
        <a href="{{ $titleHref }}" class="pub-title font-medium italic hover:underline">{{ $p.Title }}</a>.
        {{ with $venue }} <em>{{ . }}</em>{{ end }}
        {{ if or $vol $num }}
          {{ if $vol }}, {{ $vol }}{{ end }}
          {{ if $num }}({{ $num }}){{ end }}
        {{ end }}.

        {{/* ---------- Mini icons on their own line (Hugo Blox icon helper) ---------- */}}
        <div class="pub-links mt-1 text-sm space-x-3">
          {{ with $pdf }}
            <a href="{{ . }}" class="link-icon" title="PDF">
              {{ partial "functions/get_icon" (dict "name" "document-text" "pack" "hero" "attributes" "class='inline h-4 w-4 align-[-0.11em]'") }} PDF
            </a>
          {{ end }}

          {{ with $cite }}
            <a href="{{ . }}" class="link-icon" title="Cite/BibTeX">
              {{ partial "functions/get_icon" (dict "name" "bookmark" "pack" "hero" "attributes" "class='inline h-4 w-4 align-[-0.11em]'") }} CITE
            </a>
          {{ end }}

          {{ with $code }}
            <a href="{{ . }}" class="link-icon" title="Code">
              {{ partial "functions/get_icon" (dict "name" "code-bracket" "pack" "hero" "attributes" "class='inline h-4 w-4 align-[-0.11em]'") }} CODE
            </a>
          {{ end }}

          {{ with $data }}
            <a href="{{ . }}" class="link-icon" title="Dataset">
              {{ partial "functions/get_icon" (dict "name" "circle-stack" "pack" "hero" "attributes" "class='inline h-4 w-4 align-[-0.11em]'") }} DATA
            </a>
          {{ end }}

          <a href="{{ $page }}" class="link-icon" title="Project/Page">
            {{ partial "functions/get_icon" (dict "name" "globe-alt" "pack" "hero" "attributes" "class='inline h-4 w-4 align-[-0.11em]'") }} PAGE
          </a>

          {{ with $video }}
            <a href="{{ . }}" class="link-icon" title="Video">
              {{ partial "functions/get_icon" (dict "name" "play-circle" "pack" "hero" "attributes" "class='inline h-4 w-4 align-[-0.11em]'") }} VIDEO
            </a>
          {{ end }}
        </div>
      </li>
    {{ end }}

    {{ if ne $currentYear "" }}</ul></section>{{ end }}
  {{ end }}
</main>

<style>
.year-heading{border-bottom:1px solid rgba(0,0,0,.08);padding-bottom:.25rem}
.pub-item{margin-left:1rem;text-indent:-1rem}
.pub-links a{ text-decoration:none; opacity:.9 }
.pub-links a:hover{ text-decoration:underline; opacity:1 }
</style>
{{ end }}
