{{ define "main" }}
<main class="container mx-auto px-4">

  {{/* Collect publications robustly */}}
  {{ $pubs := where .Site.RegularPages "Type" "publication" }}
  {{ if eq (len $pubs) 0 }}
    {{ $pubs = where .Site.RegularPages "Section" "publication" }}
  {{ end }}

  {{ if eq (len $pubs) 0 }}
    <p>No publications found.</p>
  {{ else }}

    {{ $sorted := $pubs.ByDate.Reverse }}
    {{ $currentYear := "" }}

    {{ range $p := $sorted }}
      {{/* Get year (prefer publication_year) */}}
      {{ $y := "" }}
      {{ if $p.Params.publication_year }}
        {{ $y = printf "%v" $p.Params.publication_year }}
      {{ else }}
        {{ $y = $p.Date.Format "2006" }}
      {{ end }}

      {{ if ne $y $currentYear }}
        {{ if ne $currentYear "" }}</ul></section>{{ end }}
        <section id="y-{{ $y }}" class="mb-8">
          <h2 class="year-heading text-2xl font-semibold mt-10 mb-4">{{ $y }}</h2>
          <ul class="list-none space-y-3">
        {{ $currentYear = $y }}
      {{ end }}

      {{/* Build authors list */}}
      {{ $authors := "" }}
      {{ if $p.Params.authors }}
        {{ $authors = delimit $p.Params.authors ", " }}
      {{ end }}

      {{/* Build venue/journal info */}}
      {{ $venue := "" }}
      {{ if $p.Params.publication }}
        {{ $venue = $p.Params.publication }}
      {{ end }}
      {{ if $p.Params.journal }}
        {{ $venue = $p.Params.journal }}
      {{ end }}

      {{/* Optional volume/issue */}}
      {{ $vol := $p.Params.volume }}
      {{ $num := $p.Params.number }}

      {{/* Choose link */}}
      {{ $link := $p.RelPermalink }}
      {{ if $p.Params.url_pdf }}{{ $link = $p.Params.url_pdf }}{{ end }}
      {{ if $p.Params.url_custom }}{{ $link = $p.Params.url_custom }}{{ end }}

      <li class="pub-item leading-snug">
        {{ with $authors }}{{ . }}{{ end }}
        {{ if $y }} ({{ $y }}).{{ end }}
        <a href="{{ $link }}" class="pub-title font-medium italic hover:underline">
          {{ $p.Title }}
        </a>.
        {{ with $venue }} <em>{{ . }}</em>{{ end }}
        {{ if or $vol $num }}
          {{ if $vol }}, {{ $vol }}{{ end }}
          {{ if $num }}({{ $num }}){{ end }}.
        {{ end }}
      </li>

    {{ end }}
    {{ if ne $currentYear "" }}</ul></section>{{ end }}

  {{ end }}
</main>

<style>
.year-heading {
  border-bottom: 1px solid rgba(0,0,0,.08);
  padding-bottom: .25rem;
}
.pub-item {
  margin-left: 1rem;
  text-indent: -1rem;
}
</style>
{{ end }}
